import{R as Ie,r as l,u as me,j as r,c as Ne,g as Ce,i as I,a as Se,b as Pe}from"./index-BquUM_dP.js";import{i as J}from"./ipc-events-CqodUROu.js";import{A as fe}from"./index-TWPLI6s_.js";import{c as ve,m as H}from"./proxy-BIEmBbur.js";import{u as Ee}from"./profileStore-B9Mbf7JP.js";import{E as ye}from"./eye-BmrkTLPE.js";import{C as Re}from"./copy-BONWjHlW.js";import{G as De,S as Me,B as xe}from"./sun-B4KqhO0u.js";import{C as Fe}from"./clock-gSt0ZU7N.js";import{M as He}from"./moon-star-CUMLt3Wn.js";import{P as $e}from"./Portal-BzN9CTBx.js";import{u as ze}from"./AppShell-BXhI_JTh.js";import{C as Le}from"./circle-play-ojLLp3EH.js";import{S as _e}from"./sparkles-B3IeNLsk.js";import{X as Ge}from"./x-C_5K_ivr.js";import{P as Be}from"./plus-Al6gge0g.js";import"./use-ipc-event-CcVO0A42.js";import"./OmniDesk-BdBOPLft.js";import"./agentStreamStore-BcjkWHdN.js";import"./cloud-BWs6gXbb.js";import"./search-RYizLTqL.js";import"./formatDistanceToNow-Ctx6mZEP.js";import"./refresh-cw-BV6giV6D.js";import"./circle-check-DDsejJ4f.js";import"./trustDashboardStore-CKKody0H.js";import"./triangle-alert-CrRrQux7.js";const Oe=ve("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);const Ke=ve("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]),we=Ie.forwardRef(({tabId:o,children:a},c)=>{const[s,x]=l.useState(!1),[T,$]=l.useState(null),z=me(R=>R.tabs).find(R=>R.id===o);return l.useEffect(()=>{s&&z&&$({title:z.title||"New Tab",url:z.url||"about:blank"})},[s,z]),r.jsxs("div",{ref:c,onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1),className:"relative",style:{pointerEvents:"auto"},onClick:R=>{R.target===R.currentTarget&&R.stopPropagation()},children:[a,r.jsx(fe,{children:s&&T&&r.jsxs(H.div,{initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},className:"absolute bottom-full left-0 mb-2 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl z-[40] w-80 p-4",onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1),onClick:R=>R.stopPropagation(),onMouseDown:R=>R.stopPropagation(),style:{pointerEvents:"auto"},children:[T.thumbnail&&r.jsx("img",{src:T.thumbnail,alt:T.title,className:"w-full h-32 object-cover rounded mb-2"}),r.jsx("div",{className:"text-sm font-medium text-gray-200 mb-1 truncate",children:T.title}),r.jsx("div",{className:"text-xs text-gray-400 truncate",children:T.url})]})})]})});we.displayName="TabHoverCard";const We=we,ue=Ne((o,a)=>({visible:!1,tab:null,open:c=>o({visible:!0,tab:c}),close:()=>o({visible:!1,tab:null}),sync:c=>{const s=a().tab;s?.id===c.id&&o({tab:{...s,...c}})}}));function qe({tabId:o,url:a,containerId:c,containerName:s,containerColor:x,mode:T,sleeping:$,onClose:E}){const[z,R]=l.useState({x:0,y:0}),W=l.useRef(null),O=Ee(n=>n.policies[n.activeProfileId]),Q=O?!O.allowGhostTabs:!1,ae=O?!O.allowPrivateWindows:!1,{containers:q,setContainers:ie}=Ce(n=>({containers:n.containers,setContainers:n.setContainers})),D=me(n=>n.tabs.find(N=>N.id===o)),oe=ue(n=>n.open),Z=$??D?.sleeping??!1;l.useEffect(()=>{const n=N=>{W.current&&!W.current.contains(N.target)&&E()};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)},[E]),l.useEffect(()=>{const n=window.__lastContextMenuPos||{x:0,y:0};R({x:n.x,y:n.y})},[]),l.useEffect(()=>{q.length===0&&I.containers.list().then(n=>{Array.isArray(n)&&ie(n)}).catch(n=>{console.error("Failed to load containers for context menu:",n)})},[q.length,ie]);const L=()=>({id:D?.id??o,title:D?.title??D?.url??a??"New Tab",url:D?.url??a??"about:blank",containerId:D?.containerId??c,containerName:D?.containerName??s,containerColor:D?.containerColor??x,mode:D?.mode??T,createdAt:D?.createdAt,lastActiveAt:D?.lastActiveAt,sessionId:D?.sessionId,profileId:D?.profileId,sleeping:D?.sleeping??$??!1}),se=async()=>{if(!Q)try{await I.private.createGhostTab({url:a}),E()}catch(n){console.error("Failed to open as ghost:",n)}},K=async()=>{try{confirm("Burn this tab? All data will be permanently deleted.")&&(await I.tabs.burn(o),E())}catch(n){console.error("Failed to burn tab:",n)}},U=async()=>{if(ae)return;const n=prompt("Auto-close after (minutes):","10");if(n)try{const N=parseInt(n)*60*1e3;await I.private.createWindow({url:a,autoCloseAfter:N}),E()}catch(N){console.error("Failed to start timer:",N)}},ee=async(n,N=!0)=>{try{await I.tabs.create({url:a||"about:blank",containerId:n??c,activate:N}),E()}catch(te){console.error("Failed to duplicate tab:",te)}},_=async n=>{if(!n||n===c){E();return}try{const N=await I.tabs.setContainer(o,n);N?.success||console.warn("Failed to switch container:",N?.error)}catch(N){console.error("Failed to switch tab container:",N)}finally{E()}},M=()=>{oe(L()),E()},v=async()=>{try{await I.tabs.wake(o),E()}catch(n){console.error("Failed to wake tab:",n)}},V=T==="ghost",B=T==="private",b=[{icon:ye,label:"Peek preview",action:M},{icon:Re,label:"Duplicate Tab",action:()=>ee(c,!0),disabled:V||B},{icon:De,label:"Open as Ghost",action:se,hide:V,disabled:Q,disabledReason:"Disabled by profile policy"},{icon:Oe,label:"Burn Tab",action:K,danger:!0},{icon:Fe,label:"Start 10-min Timer",action:U,disabled:ae,disabledReason:"Disabled by profile policy"},{icon:Me,label:"Wake tab",action:v,hide:!Z}].filter(n=>!n.hide),ce=!V&&!B?q.filter(n=>n.id!==c):[],X=q.filter(n=>n.id!==c);return r.jsx(fe,{children:r.jsxs(H.div,{ref:W,initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.15},className:"fixed z-50 bg-surface-elevated text-foreground border border-subtle rounded-lg shadow-elevated py-1 min-w-[200px]",style:{left:`${z.x}px`,top:`${z.y}px`},children:[Z&&r.jsxs("div",{className:"px-3 py-2 text-xs text-amber-500 bg-amber-500/10 border-b border-subtle flex items-center gap-2",children:[r.jsx(He,{size:14}),r.jsx("span",{children:"Tab is hibernating"})]}),(c||s)&&r.jsxs("div",{className:"px-3 py-2 text-xs text-muted border-b border-subtle flex items-center gap-2",children:[r.jsx("div",{className:"w-2.5 h-2.5 rounded-full border border-gray-500/30",style:{backgroundColor:x||"#6366f1"}}),r.jsx("span",{children:s||(c==="default"?"Default container":c)})]}),b.map((n,N)=>{const te=n.icon;return r.jsxs(H.button,{whileHover:n.disabled?void 0:{scale:1.01},onClick:n.action,className:`w-full flex items-center gap-2 px-3 py-2 text-sm transition-colors ${n.danger?"text-red-500 hover:bg-red-500/10":n.disabled?"text-muted cursor-not-allowed":"text-foreground hover:bg-[color:var(--surface-muted)]/45"}`,disabled:n.disabled,title:n.disabled?n.disabledReason||"Disabled by profile policy":void 0,children:[r.jsx(te,{size:16}),r.jsx("span",{children:n.label})]},N)}),X.length>0&&r.jsxs("div",{className:"mt-1 border-t border-subtle pt-1.5",children:[r.jsxs("div",{className:"px-3 py-1 text-[11px] uppercase tracking-wide text-muted flex items-center gap-2",children:[r.jsx(xe,{size:12}),"Open copy in container"]}),r.jsx("div",{className:"flex flex-col",children:X.map(n=>r.jsxs(H.button,{whileHover:{scale:1.01},onClick:()=>ee(n.id,!0),className:"w-full flex items-center gap-2 px-3 py-1.5 text-sm text-foreground hover:bg-[color:var(--surface-muted)]/45 transition-colors",children:[r.jsx("span",{className:"w-2.5 h-2.5 rounded-full border border-gray-500/30",style:{backgroundColor:n.color||"#6366f1"}}),r.jsx("span",{className:"truncate",children:n.name})]},`open-${n.id}`))})]}),ce.length>0&&r.jsxs("div",{className:"mt-1 border-t border-subtle pt-1.5",children:[r.jsxs("div",{className:"px-3 py-1 text-[11px] uppercase tracking-wide text-muted flex items-center gap-2",children:[r.jsx(xe,{size:12}),"Move to container"]}),r.jsx("div",{className:"flex flex-col",children:ce.map(n=>r.jsxs(H.button,{whileHover:{scale:1.01},onClick:()=>_(n.id),className:"w-full flex items-center gap-2 px-3 py-1.5 text-sm text-foreground hover:bg-[color:var(--surface-muted)]/45 transition-colors",children:[r.jsx("span",{className:"w-2.5 h-2.5 rounded-full border border-gray-500/30",style:{backgroundColor:n.color||"#6366f1"}}),r.jsx("span",{className:"truncate",children:n.name})]},n.id))})]})]})})}function Ue({clusters:o,summary:a,onApply:c}){const[s,x]=l.useState(0);if(l.useEffect(()=>{o.length?s>=o.length&&x(0):x(0)},[o,s]),!o.length)return null;const T=o[s],$=typeof T.confidence=="number"?Math.round(T.confidence*100):null;return r.jsxs(H.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},className:"no-drag flex items-center gap-2 mr-3",children:[r.jsxs("button",{type:"button",onClick:()=>c(T.id),className:"flex items-center gap-1.5 rounded-full border border-blue-500/40 bg-blue-500/15 px-3 py-1.5 text-xs text-blue-100 transition-colors hover:bg-blue-500/25",title:a??"Redix suggests regrouping these tabs into a focused workspace.",children:[r.jsx(Le,{size:12}),r.jsxs("span",{className:"font-semibold",children:["Regroup ",T.label]}),$!==null&&r.jsxs("span",{className:"text-[11px] text-blue-200/80",children:[$,"%"]})]}),o.length>1&&r.jsx("button",{type:"button",onClick:()=>x(E=>(E+1)%o.length),className:"rounded-full border border-slate-700/60 p-1.5 text-[10px] text-slate-300 transition-colors hover:text-slate-100","aria-label":"Next suggested cluster",children:"â—"})]})}function Xe({entry:o,onOpen:a}){if(!o)return null;let c=o.url;try{c=new URL(o.url).hostname.replace(/^www\./,"")}catch{}const s=typeof o.confidence=="number"?Math.round(o.confidence*100):null;return r.jsx(H.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},className:"no-drag flex items-center gap-2 mr-3",children:r.jsxs("button",{type:"button",onClick:()=>a(o),className:"flex items-center gap-1.5 rounded-full border border-emerald-500/40 bg-emerald-500/15 px-3 py-1.5 text-xs text-emerald-100 transition-colors hover:bg-emerald-500/25",title:o.reason,children:[r.jsx(Ke,{size:12}),r.jsxs("span",{className:"font-semibold",children:["Scout ",c]}),s!==null&&r.jsxs("span",{className:"text-[11px] text-emerald-200/80",children:[s,"%"]})]})})}const he=typeof navigator<"u"&&"xr"in navigator,Ve="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js";async function Ye(){return typeof window>"u"?!1:window.AFRAME?!0:new Promise(o=>{const a=document.querySelector('script[data-hologram="aframe"]');if(a){a.addEventListener("load",()=>o(!0),{once:!0}),a.addEventListener("error",()=>o(!1),{once:!0});return}const c=document.createElement("script");c.src=Ve,c.async=!0,c.crossOrigin="anonymous",c.dataset.hologram="aframe",c.addEventListener("load",()=>o(!0),{once:!0}),c.addEventListener("error",()=>o(!1),{once:!0}),document.head.appendChild(c)})}function Je({visible:o,tabId:a,url:c,title:s,onClose:x}){const T=l.useRef(null),[$,E]=l.useState(he);return l.useEffect(()=>{let z=!1;if(!(!o||!T.current)){if(!he){E(!1);return}return(async()=>{const R=await Ye();z||(R?E(!0):(console.warn("[Hologram] Failed to load A-Frame runtime from CDN"),E(!1)))})(),()=>{z=!0}}},[o]),!o||!a?null:r.jsx(fe,{children:r.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md",children:r.jsxs(H.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"relative w-[720px] max-w-[92vw] rounded-3xl border border-cyan-500/40 bg-cyan-950/90 p-6 shadow-[0_20px_80px_rgba(8,145,178,0.25)]",children:[r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsxs("div",{children:[r.jsx("div",{className:"text-xs uppercase tracking-wide text-cyan-200/80",children:"Holographic Preview"}),r.jsx("div",{className:"text-lg font-semibold text-cyan-100",children:s||"Live Tab"}),r.jsx("div",{className:"text-xs text-cyan-100/70 break-all",children:c})]}),r.jsx("button",{type:"button",onClick:x,className:"rounded-full border border-cyan-400/30 bg-cyan-500/10 px-3 py-1 text-xs text-cyan-100 hover:bg-cyan-500/20",children:"Close"})]}),r.jsxs("div",{className:"mt-4 overflow-hidden rounded-2xl border border-cyan-500/30 bg-cyan-900/60 p-4",children:[!$&&r.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-16 text-center text-sm text-cyan-100/80",children:[r.jsx("p",{children:"WebXR holograms require a compatible browser/device."}),r.jsx("p",{className:"text-xs text-cyan-200/60",children:"Fallback: switch tabs to view this content directly."})]}),$&&r.jsx("div",{ref:T,className:"relative h-[360px] w-full",children:r.jsx("iframe",{src:`/hologram.html?tabId=${encodeURIComponent(a)}`,className:"h-full w-full rounded-xl border-none",allow:"xr-spatial-tracking; vr; webxr",title:`Holographic preview for tab ${a}`})})]})]})})})}const Qe="application/x-omnibrowser-tab-id",S=Pe(),ne=Se(),F=o=>o.map(a=>({id:a.id,title:a.title,active:a.active,url:a.url,mode:a.mode,containerId:a.containerId,containerColor:a.containerColor,containerName:a.containerName,createdAt:a.createdAt,lastActiveAt:a.lastActiveAt,sessionId:a.sessionId,profileId:a.profileId,sleeping:a.sleeping}));function jt(){const{setAll:o,setActive:a,activeId:c}=me(),[s,x]=l.useState([]),[T,$]=l.useState([]),[E,z]=l.useState([]),[R,W]=l.useState(null),[O,Q]=l.useState(null),[ae,q]=l.useState(null),[ie,D]=l.useState(null),[oe,Z]=l.useState({platform:"desktop",lastSentAt:null}),[L,se]=l.useState(null),[K,U]=l.useState(!1),ee=l.useRef(!1),_=l.useRef(!1),M=l.useRef(""),v=l.useRef(null),V=l.useRef(null),B=l.useRef(null),b=l.useRef(s),ce=ue(e=>e.open),X=l.useRef(null),n=l.useRef(""),N=l.useRef();l.useEffect(()=>{v.current=c},[c]);const te=l.useCallback(async e=>{if(!ne){e?.force&&($([]),z([]),W(null));return}if(X.current&&!e?.force)return X.current;const i=b.current.map(u=>`${u.id}:${u.lastActiveAt??0}`).sort().join("|");if(!e?.force&&i&&i===n.current&&T.length>0)return;const g=(async()=>{try{const u=await I.tabs.predictiveGroups(e?.force?{force:!0}:{});if(n.current=i,!u){$([]),z([]),W(null);return}$(Array.isArray(u.groups)?u.groups:[]),z(Array.isArray(u.prefetch)?u.prefetch:[]),W(u.summary?.explanation??null)}catch(u){S&&console.warn("[TabStrip] Predictive suggestions failed",u),e?.force&&($([]),z([]),W(null))}finally{X.current===g&&(X.current=null)}})();return X.current=g,g},[T.length]);l.useEffect(()=>{N.current=te},[te]),l.useEffect(()=>{K&&N.current?.({force:!0})},[K]);const le=l.useCallback(async()=>{if(ne)try{const e=await I.tabs.list();if(!Array.isArray(e))return;const i=e.map(t=>({id:t.id,title:t.title||"New Tab",url:t.url||"about:blank",active:t.active||!1,mode:t.mode||"normal",containerId:t.containerId,containerName:t.containerName,containerColor:t.containerColor,createdAt:t.createdAt,lastActiveAt:t.lastActiveAt,sessionId:t.sessionId,profileId:t.profileId})),g=i.map(t=>t.id).sort().join(",");M.current=g,x(i),b.current=i,o(F(i));const u=i.find(t=>t.active);u?(a(u.id),v.current=u.id):i.length===0&&(a(null),v.current=null),N.current?.()}catch(e){S&&console.error("[TabStrip] Failed to refresh tabs from main process:",e)}},[a,o]);l.useEffect(()=>{(()=>{const i=typeof navigator<"u"&&"xr"in navigator;D(i),i&&Z(g=>({...g,platform:"xr-ready"}))})()},[]),l.useEffect(()=>{oe.lastSentAt&&I.crossReality.sendHandoffStatus(oe)},[oe]),l.useEffect(()=>{if(!ne){let f=!0;const y=G=>{if(!f)return;const P=G.length?G:[{id:"local-initial",title:"Welcome",url:"about:blank",active:!0,mode:"normal"}];x(P),b.current=P,M.current=P.map(C=>C.id).sort().join(","),o(F(P));const A=P.find(C=>C.active)??P[0];a(A?A.id:null),v.current=A?A.id:null,U(!0)};y(b.current.length>0?b.current:s);const p=J.on("tabs:updated",G=>{if(!f)return;if(!Array.isArray(G)||G.length===0){y([]);return}const P=G.map(A=>({id:A.id,title:A.title||"New Tab",url:A.url||"about:blank",active:!!A.active,mode:A.mode||"normal",containerId:A.containerId,containerName:A.containerName,containerColor:A.containerColor,createdAt:A.createdAt,lastActiveAt:A.lastActiveAt,sessionId:A.sessionId,profileId:A.profileId,sleeping:A.sleeping}));y(P)});return()=>{f=!1,p()}}let e=!0,i=!1;const g=()=>new Promise(f=>{if(window.ipc&&typeof window.ipc.invoke=="function"){i=!0,f();return}const y=()=>{window.ipc&&typeof window.ipc.invoke=="function"&&(i=!0,f())};window.addEventListener("ipc:ready",y,{once:!0});const p=setInterval(()=>{window.ipc&&typeof window.ipc.invoke=="function"&&(clearInterval(p),i=!0,f())},100);setTimeout(()=>{clearInterval(p),i||(console.warn("IPC not ready after 5 seconds, proceeding anyway"),f())},5e3)}),u=async(f=!1)=>{if(e&&!(_.current&&!f)&&(i||await g(),!!e))try{const y=await I.tabs.list();if(!e)return;if(Array.isArray(y)&&y.length>0){const p=y.map(C=>({id:C.id,title:C.title||"New Tab",url:C.url||"about:blank",active:C.active||!1,mode:C.mode||"normal",containerId:C.containerId,containerName:C.containerName,containerColor:C.containerColor,createdAt:C.createdAt,lastActiveAt:C.lastActiveAt,sessionId:C.sessionId,profileId:C.profileId})),G=p.map(C=>C.id).sort().join(",");M.current!==G&&(M.current=G,x(p),o(F(p)));const P=p.find(C=>C.active),A=v.current;P&&P.id!==A?a(P.id):p.length>0&&!P&&p[0]&&p[0].id!==A&&(await I.tabs.activate({id:p[0].id}),a(p[0].id)),f&&U(!0)}else f&&!K&&!ee.current&&!_.current?setTimeout(async()=>{if(!(!e||K||ee.current||_.current)){try{const p=await I.tabs.list();if(Array.isArray(p)&&p.length>0){U(!0);return}}catch{}_.current=!0,U(!0);try{(!window.ipc||typeof window.ipc.invoke!="function")&&await new Promise(G=>setTimeout(G,200));const p=await I.tabs.create("about:blank");p&&p.id&&S&&console.log("[TabStrip] Initial tab created after wait:",p.id)}catch(p){S&&console.error("[TabStrip] Failed to create initial tab:",p)}finally{setTimeout(()=>{_.current=!1},1e3)}}},300):e&&(x([]),o([]),a(null),K||U(!0))}catch{f&&e&&!K&&U(!0)}},t=f=>{e&&(ee.current=f)},h=J.on("session:restoring",t),d=async f=>{if(!(!e||_.current)){_.current=!0;try{await I.tabs.create({url:f.url||"about:blank",containerId:f.containerId,mode:f.mode,profileId:f.profileId,tabId:f.id,activate:!!f.activate,createdAt:f.createdAt,lastActiveAt:f.lastActiveAt,sessionId:f.sessionId,fromSessionRestore:!0})}catch(y){S&&console.error("Failed to restore tab from session:",y)}finally{setTimeout(()=>{_.current=!1},500)}}},j=J.on("session:restore-tab",d),m=setTimeout(()=>{u(!0)},100),k=f=>{if(!e||!Array.isArray(f)){S&&console.warn("[TabStrip] handleTabUpdate: Invalid data or unmounted",{isMounted:e,tabList:f});return}const y=f.map(w=>({id:w.id,title:w.title||"New Tab",url:w.url||"about:blank",active:w.active||!1,containerId:w.containerId,containerName:w.containerName,containerColor:w.containerColor,mode:w.mode,createdAt:w.createdAt,lastActiveAt:w.lastActiveAt,sessionId:w.sessionId,profileId:w.profileId,sleeping:!!w.sleeping})),p=ue.getState();if(p.visible&&p.tab){const w=y.find(je=>je.id===p.tab?.id);w&&ue.getState().sync(w)}const P=y.find(w=>w.active)?.id||null,A=y.map(w=>w.id).sort().join(","),C=M.current;if(x(y),b.current=y,o(F(y)),C!==A&&(M.current=A),P)(v.current!==P||c!==P)&&(a(P),v.current=P);else if(y.length>0){const w=y[0].id;v.current!==w&&c!==w&&(a(w),v.current=w)}else(v.current!==null||c!==null)&&(a(null),v.current=null)},pe=J.on("tabs:updated",k),re=setInterval(()=>{e&&i&&K&&(_.current||u(!1).catch(()=>{}))},1e4);return()=>{e=!1,pe(),h(),j(),clearInterval(re),clearTimeout(m)}},[]);const be=async()=>{if(!ne){const e=(b.current.length>0?b.current:s).map(u=>({...u,active:!1})),i={id:`local-${Date.now()}`,title:"New Tab",url:"about:blank",active:!0,mode:"normal"},g=[...e,i];x(g),b.current=g,M.current=g.map(u=>u.id).sort().join(","),o(F(g)),a(i.id),v.current=i.id,J.emit("tabs:updated",F(g));return}if(_.current){S&&console.log("[TabStrip] Tab creation already in progress, skipping");return}_.current=!0;try{(!window.ipc||typeof window.ipc.invoke!="function")&&await new Promise(i=>setTimeout(i,500));const e=await I.tabs.create("about:blank");e&&e.id?S&&console.log("[TabStrip] Tab created via addTab:",e.id):S&&console.warn("[TabStrip] Tab creation returned no ID:",e)}catch(e){S&&console.error("Failed to create tab:",e)}finally{setTimeout(()=>{_.current=!1},100)}},de=async e=>{if(!ne){const m=b.current.length>0?b.current:s,k=m.findIndex(p=>p.id===e);if(k===-1)return;const pe=m[k]?.active,re=m.filter(p=>p.id!==e);let f=re;if(re.length===0)f=[{id:`local-${Date.now()}`,title:"New Tab",url:"about:blank",active:!0,mode:"normal"}];else if(pe){const p=Math.min(k,re.length-1);f=re.map((G,P)=>({...G,active:P===p}))}const y=f.find(p=>p.active)??f[0];x(f),b.current=f,M.current=f.map(p=>p.id).sort().join(","),o(F(f)),a(y?y.id:null),v.current=y?y.id:null,J.emit("tabs:updated",F(f));return}if(_.current)return;const i=b.current.length>0?b.current:s,g=i.find(m=>m.id===e);if(!g)return;const u=g.active,t=i.findIndex(m=>m.id===e),h=i.filter(m=>m.id!==e),d=i.map(m=>({...m})),j=v.current;if(x(h),b.current=h,M.current=h.map(m=>m.id).sort().join(","),o(F(h)),u&&h.length>0){const m=Math.min(t,h.length-1),k=h[m];k&&(a(k.id),v.current=k.id)}else h.length===0&&(a(null),v.current=null);S&&console.log("[TabStrip] Closing tab (optimistic):",e,"previous active:",j);try{const m=await Promise.race([I.tabs.close({id:e}),new Promise(k=>setTimeout(()=>k({success:!1,error:"Timeout"}),2e3))]);S&&console.log("[TabStrip] tabs.close result:",m),(!m||!m.success)&&(S&&console.warn("[TabStrip] Tab close failed or timed out, reverting:",e,m?.error),x(d),b.current=d,M.current=d.map(k=>k.id).sort().join(","),o(F(d)),j&&(a(j),v.current=j),await le())}catch(m){S&&console.error("[TabStrip] Exception during tab close, reverting:",m),x(d),b.current=d,M.current=d.map(k=>k.id).sort().join(","),o(F(d)),j&&(a(j),v.current=j),await le()}},Y=async e=>{if(!ne){const d=b.current.length>0?b.current:s;if(!d.find(k=>k.id===e))return;const m=d.map(k=>({...k,active:k.id===e}));x(m),b.current=m,M.current=m.map(k=>k.id).sort().join(","),o(F(m)),a(e),v.current=e,J.emit("tabs:updated",F(m));return}if(c===e||V.current===e)return;const i=b.current.length>0?b.current:s;if(!i.find(d=>d.id===e)){S&&console.warn("[TabStrip] Tab not found for activation:",e,"Available tabs:",i.map(d=>d.id));return}V.current=e;const u=v.current,t=i.map(d=>({...d}));a(e),v.current=e;const h=i.map(d=>({...d,active:d.id===e}));x(h),b.current=h,o(F(h)),S&&console.log("[TabStrip] Activating tab (optimistic):",e,"previous:",u);try{const d=await Promise.race([I.tabs.activate({id:e}),new Promise(j=>setTimeout(()=>j({success:!1,error:"Timeout"}),2e3))]);S&&console.log("[TabStrip] tabs.activate result:",d),!d||!d.success?(S&&console.warn("[TabStrip] Tab activation failed or timed out, reverting:",e,d?.error),x(t),b.current=t,M.current=t.map(j=>j.id).sort().join(","),o(F(t)),u&&(a(u),v.current=u),await le()):S&&console.log("[TabStrip] Tab activation acknowledged by IPC:",e)}catch(d){S&&console.error("[TabStrip] Exception during tab activation, reverting:",d),x(t),b.current=t,M.current=t.map(j=>j.id).sort().join(","),o(F(t)),u&&(a(u),v.current=u),await le()}finally{V.current=null}},Te=l.useCallback(e=>{const i=T.find(d=>d.id===e);if(!i||!i.tabIds.length)return;const u=b.current.filter(d=>i.tabIds.includes(d.id));if(u.length<=1)return;let t="workspace";try{u[0]?.url&&(t=new URL(u[0].url).hostname.replace(/^www\./,"")||"workspace")}catch{t="workspace"}const h=u.length>=3?`${t} cluster`:i.label;I.tabs.create({url:"about:blank",containerId:t,activate:!0}).then(async d=>{if(d?.id){for(const j of u)try{await I.tabs.moveToWorkspace({tabId:j.id,workspaceId:d.id,label:h})}catch(m){S&&console.warn("[TabStrip] Failed to regroup tab",m)}setTimeout(()=>{ze.getState().refresh()},300),N.current?.({force:!0})}})},[T]),ke=l.useCallback(e=>{e?.url&&I.tabs.create({url:e.url,activate:!0}).then(()=>{N.current?.({force:!0})})},[]);l.useEffect(()=>{if(!(!c||!B.current))try{B.current.querySelector(`[data-tab="${CSS.escape(c)}"]`)?.scrollIntoView?.({block:"nearest",inline:"nearest",behavior:"smooth"})}catch{}},[c]);const ge=l.useRef(c);l.useEffect(()=>{b.current=s,ge.current=c},[s,c]),l.useEffect(()=>{if(!B.current||!c)return;B.current.querySelector(`[data-tab="${CSS.escape(c)}"]`)?.scrollIntoView({block:"nearest",inline:"nearest"})},[c,s.length]),l.useEffect(()=>{if(!B.current||!c)return;const e=B.current.querySelector(`[data-tab="${CSS.escape(c)}"]`);e&&document.activeElement!==e&&e.focus({preventScroll:!0})},[c,s.length]);const Ae=l.useCallback(e=>{if(!["ArrowLeft","ArrowRight","Home","End"].includes(e.key))return;const i=s.findIndex(t=>t.id===c);if(i===-1)return;e.preventDefault();let g=i;switch(e.key){case"Home":g=0;break;case"End":g=s.length-1;break;case"ArrowLeft":g=(i-1+s.length)%s.length;break;case"ArrowRight":g=(i+1)%s.length;break}const u=s[g];u&&Y(u.id)},[s,c,Y]);return l.useEffect(()=>{const e=i=>{if(!(navigator.platform.toUpperCase().includes("MAC")?i.metaKey:i.ctrlKey)||i.key!=="Tab")return;const t=b.current,h=ge.current;if(!t.length||!h)return;i.preventDefault();const d=t.findIndex(k=>k.id===h);if(d===-1)return;const j=i.shiftKey?(d-1+t.length)%t.length:(d+1)%t.length,m=t[j];m&&Y(m.id)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Y]),r.jsxs(r.Fragment,{children:[r.jsxs("div",{ref:B,role:"tablist","aria-label":"Browser tabs",className:"no-drag flex items-center gap-1 px-3 py-2 bg-[#1A1D28] border-b border-gray-700/30 overflow-x-auto scrollbar-hide",style:{pointerEvents:"auto"},onKeyDown:Ae,"data-onboarding":"tabstrip",children:[r.jsx(Xe,{entry:E[0]??null,onOpen:ke}),r.jsx(Ue,{clusters:T,onApply:Te,summary:R}),r.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",style:{pointerEvents:"auto"},children:[r.jsx(fe,{mode:"popLayout",children:s.length>0?s.map(e=>{const i=`tab-${e.id}`,g=`tabpanel-${e.id}`,u=E.find(t=>t.tabId===e.id);return r.jsx(We,{tabId:e.id,children:r.jsxs(H.div,{id:i,"data-tab":e.id,role:"tab","aria-selected":e.active,"aria-controls":g,"aria-label":`Tab: ${e.title}${e.mode==="ghost"?" (Ghost tab)":e.mode==="private"?" (Private tab)":""}${e.sleeping?" (Hibernating)":""}`,tabIndex:e.active?0:-1,layout:!0,initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:`
                      relative flex items-center gap-2 px-4 py-2 rounded-lg
                      min-w-[100px] max-w-[220px] cursor-pointer group
                      transition-all duration-200
                      focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                      ${e.active?"bg-purple-600/20 border border-purple-500/40 shadow-lg shadow-purple-500/20":"bg-gray-800/30 hover:bg-gray-800/50 border border-transparent"}
                      ${e.mode==="ghost"?"ring-1 ring-purple-500/40":""}
                      ${e.mode==="private"?"ring-1 ring-emerald-500/40":""}
                      ${e.sleeping?"ring-1 ring-amber-400/40":""}
                    `,style:{pointerEvents:"auto",zIndex:1,userSelect:"none"},draggable:!0,onDragStart:t=>{try{t.dataTransfer?.setData(Qe,e.id),e.title&&t.dataTransfer?.setData("text/plain",e.title),t.dataTransfer&&(t.dataTransfer.effectAllowed="copy")}catch(h){S&&console.warn("[TabStrip] Drag start failed",h)}},onDragEnd:()=>{window.dispatchEvent(new CustomEvent("tabgraph:dragend"))},onClick:t=>{t.preventDefault(),t.stopPropagation(),Y(e.id)},onKeyDown:t=>{if(t.key==="Enter"||t.key===" "){t.preventDefault(),t.stopPropagation(),Y(e.id);return}if(["ArrowLeft","ArrowRight","Home","End"].includes(t.key)){t.preventDefault(),t.stopPropagation();const h=s.findIndex(m=>m.id===e.id);if(h===-1)return;let d=h;switch(t.key){case"Home":d=0;break;case"End":d=s.length-1;break;case"ArrowLeft":d=(h-1+s.length)%s.length;break;case"ArrowRight":d=(h+1)%s.length;break}const j=s[d];j&&Y(j.id)}},onAuxClick:t=>{t.preventDefault(),t.stopPropagation(),t.button===1&&de(e.id)},onContextMenu:t=>{t.preventDefault(),window.__lastContextMenuPos={x:t.clientX,y:t.clientY},se({tabId:e.id,url:e.url,containerId:e.containerId,containerName:e.containerName,containerColor:e.containerColor,mode:e.mode,sleeping:e.sleeping,x:t.clientX,y:t.clientY})},onMouseEnter:()=>{e===s[s.length-1]&&(Q(e.id),q({url:e.url,title:e.title}))},onMouseLeave:()=>{O===e.id&&(Q(null),q(null))},children:[u&&r.jsx("span",{className:"absolute top-1 right-2 text-emerald-300 text-[11px] font-semibold",title:`Suggested follow-up: ${u.reason}`,children:"âš¡"}),ie!==!1&&O===e.id&&r.jsxs(H.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},className:"absolute -bottom-9 left-1/2 flex -translate-x-1/2 items-center gap-2",children:[r.jsxs(H.button,{type:"button",className:"flex items-center gap-1 rounded-full border border-cyan-400/40 bg-cyan-500/15 px-3 py-1 text-[10px] text-cyan-100 shadow-lg backdrop-blur transition-colors hover:bg-cyan-500/25",onClick:t=>{t.preventDefault(),t.stopPropagation(),Z({platform:"xr",lastSentAt:Date.now()}),window.dispatchEvent(new CustomEvent("tab:holographic-preview",{detail:{tabId:e.id}})),I.crossReality.handoff(e.id,"xr")},children:[r.jsx(_e,{size:12})," XR Hologram"]}),r.jsxs(H.button,{type:"button",className:"flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/15 px-2.5 py-1 text-[10px] text-amber-100 shadow-lg backdrop-blur transition-colors hover:bg-amber-500/25",onClick:t=>{t.preventDefault(),t.stopPropagation(),Z({platform:"mobile",lastSentAt:Date.now()}),I.crossReality.handoff(e.id,"mobile")},children:[r.jsx("span",{role:"img","aria-label":"mobile",children:"ðŸ“±"})," Send"]})]}),r.jsx("div",{className:"flex-shrink-0 w-4 h-4 bg-gray-600 rounded-full flex items-center justify-center",children:e.favicon?r.jsx("img",{src:e.favicon,alt:"",className:"w-full h-full rounded-full"}):r.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full"})}),e.mode&&e.mode!=="normal"&&r.jsx("span",{className:`px-1.5 py-0.5 rounded-md text-[10px] font-medium border ${e.mode==="ghost"?"bg-purple-500/20 text-purple-200 border-purple-400/40":"bg-emerald-500/20 text-emerald-200 border-emerald-400/40"}`,children:e.mode==="ghost"?"Ghost":"Private"}),e.containerId&&e.containerId!=="default"&&r.jsx("div",{className:"w-2.5 h-2.5 rounded-full border border-gray-700/60",style:{backgroundColor:e.containerColor||"#6366f1"},title:`${e.containerName||"Custom"} container`}),e.sleeping&&r.jsx("span",{className:"flex items-center",title:"Tab is hibernating",children:r.jsx(H.span,{className:"w-2 h-2 rounded-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.55)]",animate:{scale:[1,1.25,1],opacity:[.7,1,.7]},transition:{repeat:1/0,duration:1.8,ease:"easeInOut"}})}),r.jsx("span",{className:`flex-1 text-sm truncate ${e.active?"text-gray-100":"text-gray-400"}`,children:e.title}),r.jsx(H.button,{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),ce(e)},"aria-label":`Peek preview: ${e.title}`,className:"opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-gray-700/50 transition-opacity text-gray-400 hover:text-gray-100 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 no-drag ml-1",style:{pointerEvents:"auto",zIndex:2},whileHover:{scale:1.05},whileTap:{scale:.96},title:"Peek preview",children:r.jsx(ye,{size:14})}),r.jsx(H.button,{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),de(e.id)},onAuxClick:t=>{t.button===1&&(t.preventDefault(),t.stopPropagation(),de(e.id))},onMouseDown:t=>{t.stopPropagation()},onKeyDown:t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),t.stopPropagation(),de(e.id))},"aria-label":`Close tab: ${e.title}`,className:"opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-gray-700/50 transition-opacity ml-1 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 no-drag",style:{pointerEvents:"auto",zIndex:2},whileHover:{scale:1.1},whileTap:{scale:.9},title:"Close tab (Middle click)",children:r.jsx(Ge,{size:14,className:"text-gray-400"})})]})},e.id)}):null}),r.jsx(H.button,{onClick:be,onKeyDown:e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),be())},"aria-label":"New tab",className:"flex-shrink-0 p-2 rounded-lg hover:bg-gray-800/50 border border-transparent hover:border-gray-700/30 text-gray-400 hover:text-gray-200 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",whileHover:{scale:1.05},whileTap:{scale:.95},title:"New Tab (Ctrl+T / âŒ˜T)",children:r.jsx(Be,{size:18})})]}),L&&r.jsx($e,{children:r.jsx(qe,{tabId:L.tabId,url:L.url,containerId:L.containerId??s.find(e=>e.id===L.tabId)?.containerId,containerName:L.containerName??s.find(e=>e.id===L.tabId)?.containerName,containerColor:L.containerColor??s.find(e=>e.id===L.tabId)?.containerColor,mode:L.mode??s.find(e=>e.id===L.tabId)?.mode,sleeping:L.sleeping??s.find(e=>e.id===L.tabId)?.sleeping,onClose:()=>se(null)})})]}),r.jsx(Je,{visible:!!O,tabId:O,url:ae?.url,title:ae?.title,onClose:()=>{Q(null),q(null)}})]})}export{jt as TabStrip};
//# sourceMappingURL=TabStrip-Aos3pdO7.js.map
