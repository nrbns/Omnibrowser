import{c as y,i as a}from"./index-BquUM_dP.js";import{i as n}from"./ipc-events-CqodUROu.js";const d=(e,t)=>{const l={...e};for(const o of t)l[o.id]=o;return l},p=y((e,t)=>({profiles:[],profilesById:{},policies:{},activeProfileId:"default",loading:!1,async loadProfiles(l=!1){const{loading:o}=t();if(!(o&&!l)){e({loading:!0});try{const[r,i]=await Promise.all([a.profiles.list(),a.profiles.getActive()]),s=d(t().profilesById,r);i&&(s[i.id]=i);const c={...t().policies};for(const f of r)f.policy&&(c[f.id]=f.policy);if(i?.id&&!c[i.id])try{const f=await a.profiles.getPolicy(i.id);c[i.id]=f}catch(f){console.warn("[Profiles] Failed to fetch policy for active profile",f)}e({profiles:r,profilesById:s,policies:c,activeProfileId:i?.id??"default"})}catch(r){console.error("[Profiles] Failed to load profiles",r)}finally{e({loading:!1})}}},async setActiveProfile(l){try{const o=await a.profiles.setActive(l),r=o.policy??await a.profiles.getPolicy(o.id),i=d(t().profilesById,[o]);e(s=>({activeProfileId:o.id,profilesById:i,profiles:s.profiles.map(c=>c.id===o.id?{...c,...o}:c),policies:{...s.policies,[o.id]:r}}))}catch(o){throw console.error("[Profiles] Failed to activate profile",o),o}},markPolicyMessageRead(){e({lastPolicyBlock:void 0})}}));n.on("profiles:active",e=>{if(!e?.profileId)return;const t=p.getState(),{profileId:l,profile:o}=e,r=o.policy;p.setState(i=>({activeProfileId:l,profilesById:d(i.profilesById,[o]),profiles:i.profiles.some(s=>s.id===l)?i.profiles.map(s=>s.id===l?{...s,...o}:s):[...i.profiles,o],policies:r?{...i.policies,[l]:r}:i.policies})),!t.policies[l]&&!r&&a.profiles.getPolicy(l).then(i=>{p.setState(s=>({policies:{...s.policies,[l]:i}}))}).catch(i=>console.warn("[Profiles] Failed to refresh policy",i))});n.on("profiles:policy-blocked",e=>{!e?.profileId||!e?.action||p.setState({lastPolicyBlock:{action:e.action,profileId:e.profileId,timestamp:Date.now()}})});function u(){p.getState().loadProfiles()}export{u as e,p as u};
//# sourceMappingURL=profileStore-B9Mbf7JP.js.map
