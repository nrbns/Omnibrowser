import{u as M,i as y,r as d,g as se,j as o}from"./index-BquUM_dP.js";import{u as ae}from"./OmniDesk-BdBOPLft.js";import{i as T}from"./ipc-events-CqodUROu.js";import{c as oe,m as R}from"./proxy-BIEmBbur.js";import{S as ne}from"./search-RYizLTqL.js";import{A as ie}from"./arrow-right-0_MbL2nW.js";import{S as _}from"./sparkles-B3IeNLsk.js";import{C as ce}from"./clock-gSt0ZU7N.js";import"./agentStreamStore-BcjkWHdN.js";import"./cloud-BWs6gXbb.js";import"./index-TWPLI6s_.js";import"./formatDistanceToNow-Ctx6mZEP.js";import"./refresh-cw-BV6giV6D.js";import"./circle-check-DDsejJ4f.js";const G=oe("Box",[["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]]),S=new Map,A=new Map,z=new Set;let Y=!1;function w(){z.forEach(t=>{try{t()}catch(a){console.error("[CommandRegistry] Listener error",a)}})}function K(t){return S.has(t.id)&&console.warn(`[CommandRegistry] Command with id "${t.id}" already registered. Overwriting.`),S.set(t.id,t),w(),()=>{S.delete(t.id)&&w()}}function le(t){return A.has(t.id)&&console.warn(`[CommandRegistry] Command source with id "${t.id}" already registered. Overwriting.`),A.set(t.id,t),w(),()=>{A.delete(t.id)&&w()}}async function de(){const t=Array.from(S.values()),a=await Promise.all(Array.from(A.values()).map(async c=>{try{return await c.getCommands()}catch(l){return console.error(`[CommandRegistry] Failed to load commands from source "${c.id}":`,l),[]}}));return[...t,...a.flat()]}function ue(t){return z.add(t),()=>{z.delete(t)}}function me(){Y=!0}function ye(){return Y}function pe(){w()}let D=!1;const fe=[{id:"core:new-tab",title:"Open New Tab",subtitle:"Create a blank tab in the current container",category:"Navigation",keywords:["tab","new","create"],shortcut:["Ctrl/Cmd","T"],run:async()=>{await y.tabs.create("about:blank")}},{id:"core:privacy-dashboard",title:"Open Privacy Dashboard",subtitle:"Review shields, permissions, and session data",category:"Privacy",keywords:["privacy","dashboard","settings"],run:()=>{window.location.hash="#/privacy"}},{id:"core:save-workspace",title:"Save Workspace Snapshot",subtitle:"Capture current tabs and layout into a workspace bundle",category:"Workspace",keywords:["workspace","session","save"],run:async()=>{const t=prompt("Name of the workspace snapshot?");t&&await y.storage.saveWorkspace({id:crypto.randomUUID(),name:t,partition:`persist:workspace:${Date.now()}`})}},{id:"core:burn-active-tab",title:"Burn Active Tab",subtitle:"Permanently delete data for the current tab",category:"Privacy",keywords:["burn","tab","privacy"],run:async()=>{const{activeId:t}=M.getState();!t||!confirm("Burn this tab? All associated storage will be destroyed.")||await y.tabs.burn(t)}},{id:"core:ask-agent",title:"Ask Omni Agent",subtitle:"Send a custom question to the AI agent",category:"AI",keywords:["agent","ai","question"],run:async()=>{const t=prompt("What would you like the agent to do?");t&&await y.agent.createTask({title:"Command Palette Request",role:"researcher",goal:t,budget:{tokens:4096,seconds:120,requests:20}})}}];function he(){[{id:"core:mode-browse",title:"Switch to Browse Mode",mode:"Browse"},{id:"core:mode-research",title:"Switch to Research Mode",mode:"Research"},{id:"core:mode-threats",title:"Switch to Threat Mode",mode:"Threats"},{id:"core:mode-trade",title:"Switch to Trade Mode",mode:"Trade"},{id:"core:mode-docs",title:"Switch to Docs Mode",mode:"Docs"}].forEach(a=>{K({id:a.id,title:a.title,category:"Modes",keywords:["mode",a.mode.toLowerCase()],run:()=>{ae.getState().setMode(a.mode)}})})}function ge(){fe.forEach(t=>K(t))}function be(){le({id:"dynamic:tabs",getCommands:async()=>{const{tabs:t,activeId:a}=M.getState();return t.slice(0,25).map(c=>({id:`tab:focus:${c.id}`,title:c.title||"Untitled Tab",subtitle:c.url,category:"Tabs",badge:c.id===a?"Active":void 0,keywords:[c.title,c.url].filter(Boolean),run:async()=>{await y.tabs.activate({id:c.id})}}))}}),M.subscribe(()=>{pe()})}function xe(){D||(D=!0,ge(),he(),be(),me())}function Q(){return D&&ye()}const we="https://duckduckgo.com/?q=",V={action:0,command:1,container:2,tab:3,history:4},ve=/^(https?:\/\/|chrome:\/\/|edge:\/\/|about:|file:\/\/)/i,Ce=/^[\w.-]+\.[a-z]{2,}(?:[\/?#].*)?$/i,X=(t,a="33")=>{if(!(!t||!t.startsWith("#"))){if(t.length===4){const c=t[1],l=t[2],u=t[3];return`#${c}${c}${l}${l}${u}${u}${a}`}return t.length===7?`${t}${a}`:t}},ke=t=>t?t.charAt(0).toUpperCase()+t.slice(1):"",je=t=>{const a=t.trim();if(!a)return{url:"about:blank",description:"Open a blank tab",isDirect:!0};if(ve.test(a))return{url:a,description:a,isDirect:!0};if(!/\s/.test(a)&&Ce.test(a)){const c=a.startsWith("www.")?`https://${a}`:`https://${a}`;return{url:c,description:c,isDirect:!0}}return{url:`${we}${encodeURIComponent(a)}`,description:`Search the web for “${a}”`,isDirect:!1}};function Se(t,a){if(!a)return 0;const c=t.toLowerCase(),l=a.toLowerCase();let u=0,f=0,v=-1;for(let g=0;g<l.length&&f<c.length;g++)l[g]===c[f]&&(u+=5,v===g-1&&(u+=3),g===0&&(u+=2),v=g,f++);return f===c.length&&(u+=5),u}function Ae(t,a){const c=[a.title,a.subtitle,a.category,a.badge,...a.keywords??[]];let l=0;for(const u of c){const f=Se(t,u);f>l&&(l=f)}return l}function Ue({onClose:t}){const[a,c]=d.useState(""),[l,u]=d.useState(0),[f,v]=d.useState([]),[g,Z]=d.useState(!Q()),[P,J]=d.useState([]),[O,N]=d.useState([]),[ee,$]=d.useState(!1),[L,B]=d.useState([]),{containers:b,activeContainerId:H,setContainers:I,setActiveContainer:C}=se(r=>({containers:r.containers,activeContainerId:r.activeContainerId,setContainers:r.setContainers,setActiveContainer:r.setActiveContainer})),q=d.useRef(b);d.useEffect(()=>{q.current=b},[b]),d.useEffect(()=>{Q()||xe();let r=!0;const s=async()=>{const n=await de();r&&(v(n),Z(!1),u(0))};s();const i=ue(()=>{s()});return()=>{r=!1,i()}},[]),d.useEffect(()=>{let r=!0;return(async()=>{try{const i=await y.history.list();r&&J(Array.isArray(i)?i.slice(0,20):[])}catch(i){console.warn("[CommandPalette] Failed to load history list:",i)}})(),()=>{r=!1}},[]),d.useEffect(()=>{let r=!1;b.length===0&&y.containers.list().then(n=>{!r&&Array.isArray(n)&&I(n)}).catch(n=>{console.warn("[CommandPalette] Failed to load containers:",n)});const s=T.on("containers:list",n=>{Array.isArray(n)&&I(n)}),i=T.on("containers:active",n=>{if(!n)return;const m=n.container??q.current.find(x=>x.id===n.containerId);m&&C(m)});return()=>{r=!0,s(),i()}},[b.length,I,C]),d.useEffect(()=>{let r=!1;(async()=>{try{const n=await y.tabs.list();!r&&Array.isArray(n)&&B(n)}catch(n){console.warn("[CommandPalette] Failed to load tabs:",n)}})();const i=T.on("tabs:updated",n=>{Array.isArray(n)&&B(n)});return()=>{r=!0,i()}},[]),d.useEffect(()=>{const r=a.trim();if(r.length<2){N([]),$(!1);return}let s=!1;return $(!0),(async()=>{try{const n=await y.history.search(r);s||N(Array.isArray(n)?n.slice(0,20):[])}catch(n){s||(console.warn("[CommandPalette] History search failed:",n),N([]))}finally{s||$(!1)}})(),()=>{s=!0}},[a]);const h=d.useMemo(()=>{const r=a.trim(),s=r.toLowerCase(),i=s.length>=2?O:P,n=f.map(e=>({id:e.id,title:e.title,subtitle:e.subtitle,category:e.category,type:"command",keywords:e.keywords,shortcut:e.shortcut,badge:e.badge,run:e.run})),m=b.map(e=>({id:`container:${e.id}`,title:`Switch to ${e.name}`,subtitle:e.description||`${ke(e.scope??"session")} container`,category:"Containers",type:"container",badge:e.id===H?"Active":void 0,keywords:[e.name,e.description??"",e.id,e.scope??""],meta:{color:e.color,container:e},run:async()=>{try{const j=await y.containers.setActive(e.id)||e;C(j)}catch(p){console.warn("[CommandPalette] Failed to switch container:",p)}}})),x=L.map(e=>({id:`tab:${e.id}`,title:e.title||e.url||"Untitled tab",subtitle:e.url,category:"Open Tabs",type:"tab",badge:e.active?"Current Tab":e.containerName,keywords:[e.title??"",e.url??"",e.containerName??"",e.mode??""],meta:{color:e.containerColor,active:e.active},run:async()=>{await y.tabs.activate({id:e.id})}})),E=i.map(e=>({id:`history:${e.id}`,title:e.title||e.url,subtitle:e.url,category:"History",type:"history",badge:e.visitCount?`${e.visitCount}×`:void 0,keywords:[e.url,e.title],run:async()=>{e.url&&await y.tabs.create({url:e.url})}})),F=[...r.length>0?b.map(e=>{const p=je(r);return{id:`open:${e.id}:${r}`,title:p.isDirect?`Open ${p.url} in ${e.name}`:`Search “${r}” in ${e.name}`,subtitle:p.description,category:"Open in Container",type:"action",badge:"New Tab",keywords:[r,e.name,e.id],meta:{color:e.color},run:async()=>{await y.tabs.create({url:p.url,containerId:e.id})}}}):[],...n,...m,...x,...E];return s?F.map(e=>({item:e,score:Ae(s,e)})).filter(({score:e})=>e>0).sort((e,p)=>{if(p.score!==e.score)return p.score-e.score;const j=V[e.item.type]??99,W=V[p.item.type]??99;return j!==W?j-W:e.item.title.localeCompare(p.item.title)}).slice(0,30).map(({item:e})=>e):F.slice(0,30)},[a,f,b,H,L,O,P,C]),k=h,te=d.useMemo(()=>{const r=[];let s="";return h.forEach((i,n)=>{i.category!==s?(s=i.category,r.push({category:s,items:[i],startIndex:n})):r[r.length-1]?.items.push(i)}),r},[h]);d.useEffect(()=>{const r=s=>{s.key==="Escape"?t():s.key==="ArrowDown"?(s.preventDefault(),u(i=>Math.min(i+1,Math.max(k.length-1,0)))):s.key==="ArrowUp"?(s.preventDefault(),u(i=>Math.max(i-1,0))):s.key==="Enter"&&(s.preventDefault(),k[l]&&(k[l].run(),t()))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[l,k,t]),d.useEffect(()=>{l>=h.length&&u(h.length>0?h.length-1:0)},[h,l]);const re=r=>{const s=typeof r.meta?.color=="string"?r.meta.color:void 0,i="inline-flex h-6 w-6 items-center justify-center rounded-lg border text-[11px]",n=s!=null?i:`${i} border-gray-700 bg-gray-800/60 text-gray-300`,m=s!=null?{borderColor:X(s,"66")??s,backgroundColor:X(s,"22")??s,color:s}:void 0;if(r.icon)return o.jsx("span",{className:n,style:m,children:r.icon});switch(r.type){case"history":return o.jsx("span",{className:n,style:m,children:o.jsx(ce,{size:14})});case"container":return o.jsx("span",{className:n,style:m,children:o.jsx(G,{size:14})});case"tab":return o.jsx("span",{className:n,style:m,children:o.jsx(G,{size:12})});case"action":return o.jsx("span",{className:n,style:m,children:o.jsx(_,{size:14})});default:return o.jsx("span",{className:n,style:m,children:o.jsx(_,{size:14})})}};return o.jsxs(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-start justify-center pt-[15vh]",onClick:t,children:[o.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm"}),o.jsxs(R.div,{initial:{scale:.95,opacity:0,y:-20},animate:{scale:1,opacity:1,y:0},exit:{scale:.95,opacity:0,y:-20},onClick:r=>r.stopPropagation(),className:"relative w-full max-w-2xl mx-4 bg-gray-900/95 backdrop-blur-xl border border-gray-800/50 rounded-2xl shadow-2xl overflow-hidden",children:[o.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-b border-gray-800/50",children:[o.jsx(ne,{size:20,className:"text-gray-400"}),o.jsx("input",{type:"text",value:a,onChange:r=>{c(r.target.value),u(0)},autoFocus:!0,placeholder:"Type a command or search...",className:"flex-1 bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none"}),o.jsx("kbd",{className:"px-2 py-1 bg-gray-800 border border-gray-700 rounded text-xs text-gray-400",children:"Esc"})]}),o.jsx("div",{className:"max-h-96 overflow-y-auto",children:h.length>0?o.jsx("div",{className:"py-2",children:te.map(r=>o.jsxs("div",{children:[o.jsx("div",{className:"px-4 pt-3 pb-1 text-[11px] uppercase tracking-wider text-gray-500",children:r.category}),o.jsx("div",{className:"flex flex-col",children:r.items.map((s,i)=>{const n=r.startIndex+i,m=l===n,x=re(s);return o.jsxs(R.button,{onClick:()=>{s.run(),t()},onMouseEnter:()=>u(n),className:`w-full flex items-center justify-between px-4 py-3 text-left transition-colors ${m?"bg-blue-600/20 border-l-2 border-blue-500":"hover:bg-gray-800/40 border-l-2 border-transparent"}`,children:[o.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[x,o.jsxs("div",{className:"flex-1 min-w-0",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"text-sm font-medium text-gray-200 truncate",children:s.title}),s.badge&&o.jsx("span",{className:"rounded-full border border-gray-700 bg-gray-800/60 px-2 py-0.5 text-[10px] uppercase tracking-wide text-gray-400",children:s.badge})]}),s.subtitle&&o.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.subtitle})]})]}),o.jsxs("div",{className:"flex items-center gap-2 ml-4 shrink-0",children:[s.shortcut&&o.jsx("span",{className:"flex items-center gap-1 text-[11px] text-gray-500",children:s.shortcut.map((E,U)=>o.jsx("kbd",{className:"rounded border border-gray-700 bg-gray-800/60 px-1.5 py-0.5 text-[10px] text-gray-400",children:E},`${s.id}-sc-${U}`))}),o.jsx(ie,{size:16,className:"text-gray-500"})]})]},s.id)})})]},`section-${r.category}`))}):o.jsx("div",{className:"py-8 text-center text-gray-500 text-sm",children:g||ee?"Searching…":"No commands found"})}),o.jsxs("div",{className:"px-4 py-2 border-t border-gray-800/50 flex items-center justify-between text-xs text-gray-500",children:[o.jsxs("div",{className:"flex items-center gap-4",children:[o.jsx("span",{children:"↑↓ Navigate"}),o.jsx("span",{children:"↵ Select"}),o.jsx("span",{children:"Esc Close"})]}),o.jsxs("span",{children:[h.length," results"]})]})]})]})}export{Ue as CommandPalette};
//# sourceMappingURL=CommandPalette-5t_z4PHY.js.map
